name: ReleaseAndDeploy

on:
  workflow_run:
    workflows: ["INControllerCI"]
    types:
      - completed

jobs:
  release-and-deploy:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: Checkout repository at same commit as CI
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Vite app
        run: npm run build

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          echo "Previous tag: $PREV_TAG"

          {
            echo "## Changelog"
            echo
            echo "Changes since $PREV_TAG:"
            echo
            git log -1 --pretty=format:'%s%n%n%b'
            echo
            echo "---"
            echo
            echo "Deployed page:"
            echo "https://lilininl.github.io/ProfileWebpageByIN/"
          } > CHANGELOG.md

      - name: Prepare version tag
        id: version
        run: |
          N=$((GITHUB_RUN_NUMBER-1))
          MAJOR=$((1 + N/100))
          MINOR=$(((N/10)%10))
          PATCH=$((N%10))
          echo "version: v${MAJOR}.${MINOR}.${PATCH}"
          echo "TAG=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: Release ${{ steps.version.outputs.TAG }}
          draft: false
          prerelease: false
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          keep_files: true
